{% extends "base.html" %}

{% block title %}My Profile - Smart Clinic{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Patient Profile</h4>
            </div>
            <div class="card-body">
                {% if profile %}
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> {{ profile.first_name }} {{ profile.last_name }}</p>
                            <p><strong>Username:</strong> {{ profile.username }}</p>
                            <p><strong>Gender:</strong> {{ profile.gender or 'Not specified' }}</p>
                            <p><strong>Date of Birth:</strong> {{ profile.date_of_birth }}</p>
                            <p><strong>Blood Type:</strong> {{ profile.blood_type or 'Not specified' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Phone:</strong> {{ profile.phone or 'Not specified' }}</p>
                            <p><strong>Email:</strong> {{ profile.email or 'Not specified' }}</p>
                            <p><strong>National ID:</strong> {{ profile.national_id or 'Not specified' }}</p>
                            <p><strong>Address:</strong> {{ profile.address or 'Not specified' }}</p>
                            <p><strong>Member Since:</strong> {{ profile.created_at.split()[0] }}</p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h5>Emergency Contact</h5>
                        <p><strong>Name:</strong> {{ profile.emergency_contact or 'Not specified' }}</p>
                        <p><strong>Phone:</strong> {{ profile.emergency_phone or 'Not specified' }}</p>
                    </div>
                {% else %}
                    <p>Error loading profile information.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4>Medical History</h4>
            </div>
            <div class="card-body">
                {% if medical_history %}
                    <div class="mb-3">
                        <h5>Chronic Diseases</h5>
                        <p>{{ medical_history.chronic_diseases or 'None reported' }}</p>
                    </div>

                    <div class="mb-3">
                        <h5>Allergies</h5>
                        <p>{{ medical_history.allergies or 'None reported' }}</p>
                    </div>

                    <div class="mb-3">
                        <h5>Current Medications</h5>
                        <p>{{ medical_history.current_medications or 'None reported' }}</p>
                    </div>

                    <div class="mb-3">
                        <h5>Past Surgeries</h5>
                        <p>{{ medical_history.past_surgeries or 'None reported' }}</p>
                    </div>

                    <div class="mb-3">
                        <h5>Family History</h5>
                        <p>{{ medical_history.family_history or 'None reported' }}</p>
                    </div>

                    <div class="mb-3">
                        <h5>Additional Notes</h5>
                        <p>{{ medical_history.notes or 'No additional notes' }}</p>
                    </div>

                    <p class="text-muted">Last updated: {{ medical_history.last_updated }}</p>
                {% else %}
                    <p>No medical history recorded yet.</p>
                {% endif %}

                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#medicalHistoryModal">
                    Update Medical History
                </button>
            </div>
        </div>
    </div>


</div>

<!-- Medical History Modal -->
<div class="modal fade" id="medicalHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Medical History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="medical-history-form">
                    <div class="mb-3">
                        <label for="chronic_diseases" class="form-label">Chronic Diseases</label>
                        <textarea class="form-control" id="chronic_diseases" name="chronic_diseases" rows="2">{{ medical_history.chronic_diseases if medical_history else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="allergies" class="form-label">Allergies</label>
                        <textarea class="form-control" id="allergies" name="allergies" rows="2">{{ medical_history.allergies if medical_history else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="current_medications" class="form-label">Current Medications</label>
                        <textarea class="form-control" id="current_medications" name="current_medications" rows="2">{{ medical_history.current_medications if medical_history else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="past_surgeries" class="form-label">Past Surgeries</label>
                        <textarea class="form-control" id="past_surgeries" name="past_surgeries" rows="2">{{ medical_history.past_surgeries if medical_history else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="family_history" class="form-label">Family History</label>
                        <textarea class="form-control" id="family_history" name="family_history" rows="2">{{ medical_history.family_history if medical_history else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2">{{ medical_history.notes if medical_history else '' }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-medical-history">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // Medical history update
    document.getElementById('save-medical-history').addEventListener('click', async () => {
        const form = document.getElementById('medical-history-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.patient_id = {{ profile.patient_id }};

        try {
            const response = await fetch('/medical_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (result.status === 'success') {
                alert(result.message);
                window.location.reload();
            } else {
                alert(result.error || "Error updating medical history");
            }
        } catch (err) {
            console.error("Error updating medical history:", err);
            alert("Error updating medical history. Please try again.");
        }
    });
});

// Cleanup when leaving page
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}